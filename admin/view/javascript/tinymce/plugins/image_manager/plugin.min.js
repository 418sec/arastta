tinymce.PluginManager.add("image_manager", function (a) {
    a.addButton("image_manager", {
        icon         : "image",
        tooltip      : "Insert/edit image",
        onclick: function() {
            $('.mce-ico.mce-i-image').attr('data-toggle', 'image');

            showImageManager(this)},
        stateSelector: "img:not([data-mce-object],[data-mce-placeholder])"
    }),
    a.addMenuItem("image_manager", {
        icon            : "image",
        text            : "Insert/edit image",
        onclick: function() {
            $('.mce-ico.mce-i-image').attr('data-toggle', 'image');

            showImageManager(this)},
        context         : "insert",
        prependToContext: !0
    })
});

function showImageManager(editor) {
    $('#modal-image').remove();

    var main = $('#' + editor._id).parent().parent().parent().parent().parent().parent().parent().find('.mce-edit-area.mce-panel.mce-stack-layout-item iframe html .mce-content-body').focus();

    $.ajax({
        url: 'index.php?route=common/filemanager&token=' + getURLVar('token'),
        dataType: 'html',
        beforeSend: function() {
            $('#button-image i').replaceWith('<i class="fa fa-circle-o-notch fa-spin"></i>');
            $('#button-image').prop('disabled', true);
        },
        complete: function() {
            $('#button-image i').replaceWith('<i class="fa fa-upload"></i>');
            $('#button-image').prop('disabled', false);
        },
        success: function(html) {
            $('body').append('<div id="modal-image" class="modal">' + html + '</div>');

            $('#modal-image').modal('show');
        }
    });
}